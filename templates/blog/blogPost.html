{% extends 'base.html' %}
{% load static %}

{% block title %} Blogpost{% endblock title %}

{% block body %}
{% load humanize %}
{% load extras %}
<div class="container my-3">
<div class="blog-post">
        <h2 class="blog-post-title">{{post.title}}</h2>
        <p class="blog-post-meta">{{post.timeStamp}} by <a href="#">{{post.auther}}</a></p>
        <p><i class="bi bi-eye me-1"></i><span class="views-count">{{ post.views }} views</p>

        <p>{{post.content|safe}}</p>
      
      </div>
      </div>

      <div class="container mt-5">
        <h4 class="mb-4">Comments ({{ comments|length }})</h4>
        
        <div class="my-2">
          {% if user.is_authenticated %}
          <!-- Comment Form -->
          <form action="/blog/postComment" method="post" class="mb-4">
          {% csrf_token %}
          <div class="form-group mb-2">
            <textarea class="form-control" name="comment" rows="3" placeholder="Write a comment..." required></textarea>
          </div>
          <input type="hidden" name="postSno" value="{{ post.sno }}">
          <input type="hidden" name="parentSno" value="">
          <button type="submit" class="btn btn-primary">Post Comment</button>
          </form>
        
          {% else %}
          <p>Please login to post comments</p>
          {% endif %}
        </div>
      

      
        <!-- Comment List -->
        {% for comment in comments %}
        <div class="d-flex mb-4 border-bottom pb-3">
          <div class="flex-shrink-0">
            <img src="{% static 'img/user.png' %}" alt="User" class="rounded-circle" width="70" height="45">
          </div>
          <div class="flex-grow-1 ms-3">
            <div class="d-flex align-items-center mb-1">
              <strong class="me-2">{{ comment.user.username }}</strong>
              <small class="text-muted">{{ comment.timestamp|naturaltime }}</small>
            </div>
            <p class="mb-0">{{ comment.comment }}</p>
            
            {% if user.is_authenticated %}
            <div class="reply mx-0 mt-2">
              <button class="btn btn-sm btn-primary" type="button" 
              data-bs-toggle="collapse" 
              data-bs-target="#replyBox{{comment.sno}}" 
              aria-expanded="false" 
              aria-controls="replyBox{{comment.sno}}">
              Reply
            </button>
             <div class="collapse" id="replyBox{{comment.sno}}">
                 <div class="card card-body my-2">
                     <form action="/blog/postComment" method="post">
                         {% csrf_token %}
                         <div class="form-group">
                             <label for="comment">Post a reply </label>
                             <input type="text" class="form-control" name="comment" placeholder="Enter comment here">
                             <input type="hidden" name="parentSno" value="{{comment.sno}}">
                         </div>
                         <input type="hidden" name="postSno" value="{{post.sno}}">
                         <button type="submit" class="btn btn-primary">Submit</button>
                     </form>
                 </div>
             </div>
             {% else %}
             <button class="btn btn-sm btn-primary" type="button" 
              data-bs-toggle="collapse" 
              data-bs-target="#replyBox{{comment.sno}}" 
              aria-expanded="false" 
              aria-controls="replyBox{{comment.sno}}" disabled>
              Login to Reply
            </button>
             {% endif %}
             <div class="replies">
              {% for reply in replyDict|get_val:comment.sno  %}
              <div class="row my-3">
                <div class="col-auto">
                  <img src="{% static 'img/user.png' %}" alt="User" class="rounded-circle" width="60" height="38">
                </div>
                <div class="col">
                  <div class="d-flex align-items-center mb-1">
                    <strong class="me-2">{{ reply.user.username }}</strong>
                    <small class="text-muted">{{ reply.timestamp|naturaltime }}</small>
                  </div>
                  <div>{{ reply.comment }}</div>
                </div>
              </div>
              
              
              
              {% endfor %}
             </div>
       </div>
            
          </div>
        </div>
        
        {% empty %}
        <p class="text-muted">No comments yet. Be the first to comment!</p>
        {% endfor %}
      </div>
{% endblock %}